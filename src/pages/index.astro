---
import '../styles/global.css';
import MainLayout from '../layouts/MainLayout.astro';
---
<MainLayout>
  <!-- 主页英雄区 -->
  <section class="max-w-6xl mx-auto mt-4 mb-12 flex flex-col lg:flex-row gap-4 items-stretch">
    <!-- 主卡片 -->
    <div class="flex-1 lg:flex-[1.2] group hero-card rounded-4xl p-8 lg:px-12 lg:py-10 border border-slate-100/50 shadow-sm transition-all duration-700 hover:shadow-xl animate-fade-up">
      <div class="relative z-10 flex flex-col h-full justify-between">
        <!-- 顶部状态栏 -->
        <div class="flex justify-between items-start">
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900/90 shadow-md backdrop-blur-sm">
            <span class="flex h-1.5 w-1.5">
              <span class="animate-ping absolute inline-flex h-1.5 w-1.5 rounded-full bg-blue-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-blue-400"></span>
            </span>
            <span class="text-[8px] font-black text-white uppercase tracking-widest">Active Concept</span>
          </div>
          <span class="text-slate-400 font-mono text-[9px] font-bold tracking-wider">EST. 2024</span>
        </div>

        <!-- 标题区 -->
        <div class="space-y-4 my-20">
          <h1 class="text-5xl lg:text-7xl font-black tracking-tighter text-slate-800 leading-none">
            派小站
          </h1>
          <p class="text-slate-500 text-sm font-medium max-w-65 leading-relaxed">
            以<span class="text-slate-900 font-semibold">精密</span>与逻辑，构建理想的数字花园。记录技术与生活的复盘。
          </p>
        </div>

        <!-- 底部信息 -->
        <div class="flex items-end justify-between border-t border-slate-200/60 pt-5">
          <div class="space-y-0.5">
            <p class="text-[9px] font-black uppercase tracking-widest text-slate-900">V4 Engine</p>
            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Modular System</p>
          </div>
          <div class="text-[9px] font-mono text-slate-400 font-bold uppercase tracking-wider">Scenery / 01</div>
        </div>
      </div>
    </div>

    <!-- 分类卡片区 -->
    <div class="flex-1 lg:flex-[0.8] flex flex-col gap-4">
      <!-- 技术笔记 -->
      <a href="/categories/技术" class="flex-1 p-7 lg:p-8 category-card-tech rounded-4xl flex flex-col justify-between group relative transition-all duration-500 hover:-translate-y-2 shadow-lg shadow-blue-200 animate-fade-up delay-100">
        <div class="flex justify-between items-start z-10">
          <div class="w-12 h-12 rounded-2xl bg-white/20 border border-white/30 backdrop-blur-md flex items-center justify-center transition-transform duration-300 group-hover:scale-110">
            <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"/></svg>
          </div>
          <div class="text-white/30 group-hover:text-white transition-all duration-300 transform group-hover:translate-x-1">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
          </div>
        </div>
        <div class="z-10">
          <h2 class="text-2xl font-black text-white tracking-tight mb-1">技术笔记</h2>
          <p class="text-white/70 text-[8px] uppercase tracking-[0.25em] font-bold">Logic & Knowledge</p>
        </div>
      </a>

      <!-- 个人随笔 -->
      <a href="/categories/生活" class="flex-1 p-7 lg:p-8 category-card-life bg-white border border-slate-100 rounded-4xl flex flex-col justify-between group hover:shadow-xl transition-all duration-500 hover:-translate-y-2 animate-fade-up delay-200">
        <div class="flex justify-between items-start relative z-10">
          <div class="w-12 h-12 rounded-2xl bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400 group-hover:text-blue-500 group-hover:bg-blue-50 transition-all duration-500 group-hover:scale-110">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
          </div>
          <div class="text-slate-300 group-hover:text-slate-900 transition-all duration-300 transform group-hover:translate-x-1">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
          </div>
        </div>
        <div class="relative z-10">
          <h2 class="text-2xl font-black text-slate-800 tracking-tight mb-1">个人随笔</h2>
          <p class="text-slate-400 text-[8px] uppercase tracking-[0.25em] font-bold">Insight & Moments</p>
        </div>
      </a>
    </div>
  </section>

  <!-- 近期文章区 -->
  <section class="max-w-6xl mx-auto p-4">
    <div class="flex items-center gap-2 mb-8">
      <div class="h-px bg-slate-300 mt-1 w-[32px]"></div>
      <h2 class="text-[24px] lg:text-[32px] font-bold uppercase tracking-[0.4em] text-slate-600 leading-none select-none animate-fade-up delay-300">近期文章</h2>
      <div class="flex-1 h-px bg-slate-300 mt-1"></div>
    </div>

    <!-- 文章列表容器 -->
    <div class="post-grid px-8 mb-4" id="post-grid">
      <!-- 初始加载状态 -->
      <div id="loading-state" class="flex flex-col items-center justify-center py-20 text-center">
        <div class="flex gap-2 mb-4">
          <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
        <p class="text-slate-400 text-sm font-medium">加载文章中...</p>
      </div>
    </div>

    <!-- 加载更多按钮 -->
    <div class="text-center hidden" id="load-more-wrapper">
      <button
        id="load-more-btn"
        class="load-more-btn inline-flex items-center gap-4 px-12 py-4 rounded-full border border-slate-200 text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] hover:bg-slate-900 hover:text-white hover:border-slate-900 transition-all duration-500 group"
      >
        <span class="w-1.5 h-1.5 rounded-full bg-blue-500 group-hover:animate-pulse transition-all duration-300"></span>
        <span id="load-more-text">加载更多</span>
      </button>
    </div>
  </section>

  <!-- 文章卡片模板（用于动态创建） -->
  <template id="post-card-template">
    <article class="post-card group">
      <div class="post-content relative z-10">
        <span class="category-tag"></span>
        <div class="post-thumbnail mb-6"></div>
        <a class="block group/title">
          <h3 class="post-title"></h3>
        </a>
        <p class="post-description"></p>
        <div class="post-tags-container flex flex-wrap gap-2 mt-4 mb-6 relative z-20"></div>
        <div class="post-footer">
          <div class="flex items-center gap-3">
            <time></time>
          </div>
          <span class="read-more-btn">Open Project _</span>
        </div>
      </div>
    </article>
  </template>
</MainLayout>

<script>
  // ============================================================================
  // 类型定义
  // ============================================================================
  interface Post {
    category: string;
    image?: string;
    title: string;
    slug: string;
    description: string;
    tags?: string[];
    pubDate: string;
  }

  interface PostsResponse {
    posts: Post[];
    hasNext: boolean;
  }

  // ============================================================================
  // 状态管理
  // ============================================================================
  const state = {
    loadedPages: new Set<number>(),
    currentPage: 0,
    isLoading: false,
  };

  // ============================================================================
  // DOM 元素引用
  // ============================================================================
  const elements = {
    postGrid: document.getElementById('post-grid') as HTMLElement,
    loadMoreBtn: document.getElementById('load-more-btn') as HTMLButtonElement,
    loadMoreText: document.getElementById('load-more-text') as HTMLElement,
    loadMoreWrapper: document.getElementById('load-more-wrapper') as HTMLElement,
    loadingState: document.getElementById('loading-state') as HTMLElement,
    template: document.getElementById('post-card-template') as HTMLTemplateElement,
  };

  // ============================================================================
  // 工具函数
  // ============================================================================
  const TAG_CLASS = 'text-[10px] uppercase tracking-wider px-2.5 py-1.5 bg-slate-100/80 text-slate-500 rounded-lg hover:bg-blue-500 hover:text-white transition-all duration-300 cursor-default hover:shadow-md hover:shadow-blue-500/20';
  const TAG_LINK_CLASS = 'no-underline';

  // 格式化日期
  const formatDate = (dateString: string): string => {
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    });
  };

  // ============================================================================
  // UI 渲染函数
  // ============================================================================
  // 创建单个文章卡片
  const createPostCard = (post: Post, index: number): HTMLElement | null => {
    const clone = elements.template.content.cloneNode(true) as DocumentFragment;
    const article = clone.querySelector('article') as HTMLElement;
    if (!article) return null;

    // 设置动画
    article.classList.add('animate-fade-up');
    article.style.animationDelay = `${Math.min(index * 0.1, 0.5)}s`;
    article.style.opacity = '0';

    // 设置分类
    const categoryTag = article.querySelector('.category-tag') as HTMLElement;
    categoryTag.textContent = post.category;

    // 设置缩略图
    if (post.image) {
      const thumbnailDiv = article.querySelector('.post-thumbnail') as HTMLElement;
      thumbnailDiv.innerHTML = `<img src="${post.image}" alt="${post.title}" loading="lazy" />`;
    } else {
      article.querySelector('.post-thumbnail')?.remove();
    }

    // 设置标题和链接
    const titleLink = article.querySelector('.group\\/title') as HTMLAnchorElement;
    const title = article.querySelector('.post-title') as HTMLElement;
    titleLink.href = `/blog/${post.slug}`;
    title.textContent = post.title;

    // 设置描述
    const description = article.querySelector('.post-description') as HTMLElement;
    description.textContent = post.description;

    // 设置标签
    const tagsContainer = article.querySelector('.post-tags-container') as HTMLElement;
    if (post.tags?.length) {
      post.tags.forEach((tag) => {
        const tagSpan = document.createElement('span');
        tagSpan.className = TAG_CLASS;

        const tagLink = document.createElement('a');
        tagLink.href = `/tags/${tag}`;
        tagLink.textContent = tag;
        tagLink.className = TAG_LINK_CLASS;

        tagSpan.appendChild(tagLink);
        tagsContainer.appendChild(tagSpan);
      });
    } else {
      tagsContainer.remove();
    }

    // 设置日期
    const time = article.querySelector('time') as HTMLElement;
    // time.dateTime = new Date(post.pubDate).toISOString();
    time.textContent = formatDate(post.pubDate);

    return article;
  };

  // 渲染文章列表
  const renderPosts = (posts: Post[], startIndex = 0): void => {
    posts.forEach((post, index) => {
      const postCard = createPostCard(post, startIndex + index);
      postCard && elements.postGrid.appendChild(postCard);
    });
  };

  // 显示/隐藏加载更多按钮
  const toggleLoadMoreButton = (show: boolean): void => {
    elements.loadMoreWrapper.classList.toggle('hidden', !show);
  };

  // 更新按钮加载状态
  const setButtonLoading = (loading: boolean): void => {
    elements.loadMoreBtn.disabled = loading;
    elements.loadMoreText.textContent = loading ? '加载中...' : '加载更多';
  };

  // 显示加载失败状态
  const showError = (): void => {
    elements.loadingState.innerHTML = `
      <p class="text-red-400 text-sm mb-4">加载失败</p>
      <button onclick="location.reload()" class="text-blue-500 hover:underline text-sm">重试</button>
    `;
  };

  // ============================================================================
  // 数据加载
  // ============================================================================
  // 加载指定页的文章
  const loadPage = async (pageNum: number): Promise<PostsResponse | null> => {
    if (state.isLoading) return null;

    state.isLoading = true;

    try {
      const response = await fetch(`/api/posts/${pageNum}.json`);
      if (!response.ok) throw new Error('Failed to load posts');

      const data: PostsResponse = await response.json();

      // 移除初始加载状态
      elements.loadingState.remove();

      // 渲染文章
      if (data.posts?.length) {
        const startIndex = state.loadedPages.size * 10;
        renderPosts(data.posts, startIndex);

        state.loadedPages.add(pageNum);
        state.currentPage = pageNum;

        // 更新加载更多按钮状态
        toggleLoadMoreButton(data.hasNext);
      } else {
        toggleLoadMoreButton(false);
      }

      return data;
    } catch (error) {
      console.error('Error loading posts:', error);
      showError();
      return null;
    } finally {
      state.isLoading = false;
    }
  };

  // 加载更多文章
  const loadMorePosts = async (): Promise<void> => {
    const nextPage = state.currentPage + 1;
    setButtonLoading(true);

    await loadPage(nextPage);

    if (!elements.loadMoreWrapper.classList.contains('hidden')) {
      setButtonLoading(false);
    }
  };

  // ============================================================================
  // 初始化
  // ============================================================================
  const init = async (): Promise<void> => {
    const data = await loadPage(1);
    if (!data?.hasNext) {
      toggleLoadMoreButton(false);
    }
  };

  // 绑定事件并启动
  elements.loadMoreBtn.addEventListener('click', loadMorePosts);
  init();
</script>
