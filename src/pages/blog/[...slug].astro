---
import MainLayout from '../../layouts/MainLayout.astro';
import '../../styles/global.css';
import { getCollection } from 'astro:content';

// 生成所有文章的路径
export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

// 获取当前文章数据
const { entry } = Astro.props;
const { Content, remarkPluginFrontmatter } = await entry.render();

// 计算阅读时间（基于描述长度简单估算）
// 更精确的方式需要统计渲染后的内容，但这里用描述长度作为参考
const wordCount = entry.data.description.length || 100;
const readTime = Math.max(1, Math.ceil(wordCount / 200));

// 获取所有文章用于相关推荐（简单实现：同分类文章）
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(post => post.slug !== entry.slug && post.data.category === entry.data.category)
  .slice(0, 3);
---

<MainLayout title={entry.data.title}>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <!-- 面包屑导航 -->
    <nav class="flex items-center gap-2 text-sm text-slate-500 mb-8">
      <a href="/" class="hover:text-blue-600 transition-colors">首页</a>
      <span class="text-slate-300">/</span>
      <a href="/blog" class="hover:text-blue-600 transition-colors">文章</a>
      <span class="text-slate-300">/</span>
      <span class="text-slate-700">{entry.data.title}</span>
    </nav>

    <!-- 文章头部 -->
    <header class="mb-12">
      <!-- 分类和标签 -->
      <div class="flex flex-wrap items-center gap-3 mb-6">
        <a
          href={`/categories/${entry.data.category}`}
          class="inline-flex items-center gap-1.5 px-4 py-1.5 bg-blue-50 text-blue-600 rounded-full text-xs font-black uppercase tracking-wider hover:bg-blue-100 transition-colors"
        >
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
          </svg>
          {entry.data.category}
        </a>

        {entry.data.tags && entry.data.tags.length > 0 && (
          entry.data.tags.map(tag => (
            <a
              href={`/tags/${tag}`}
              class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-full text-xs font-semibold uppercase tracking-wider hover:bg-blue-500 hover:text-white transition-all duration-300"
            >
              <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 8.25h15m-16.5 4.5h15m-16.5 4.5h15m-16.5 4.5h15" />
              </svg>
              {tag}
            </a>
          ))
        )}
      </div>

      <!-- 标题 -->
      <h1 class="text-4xl lg:text-5xl font-black text-slate-900 tracking-tight leading-tight mb-6">
        {entry.data.title}
      </h1>

      <!-- 描述 -->
      {entry.data.description && (
        <p class="text-xl text-slate-600 leading-relaxed mb-8">
          {entry.data.description}
        </p>
      )}

      <!-- 元信息 -->
      <div class="flex flex-wrap items-center gap-6 text-sm text-slate-500 border-t border-b border-slate-200 py-4">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          <time datetime={entry.data.pubDate.toISOString()}>
            {entry.data.pubDate.toLocaleDateString('zh-CN', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })}
          </time>
        </div>

        <div class="flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>约 {readTime} 分钟阅读</span>
        </div>

        {entry.data.image && (
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
            <span>含配图</span>
          </div>
        )}
      </div>
    </header>

    <!-- 封面图 -->
    {entry.data.image && (
      <div class="mb-12 rounded-3xl overflow-hidden shadow-2xl shadow-blue-500/10">
        <img
          src={entry.data.image}
          alt={entry.data.title}
          class="w-full h-auto"
          loading="lazy"
        />
      </div>
    )}

    <!-- 文章正文 -->
    <div class="prose prose-lg prose-slate max-w-none">
      <Content />
    </div>

    <!-- 文章底部标签 -->
    {entry.data.tags && entry.data.tags.length > 0 && (
      <div class="mt-12 pt-8 border-t border-slate-200">
        <h3 class="text-sm font-black uppercase tracking-wider text-slate-700 mb-4">文章标签</h3>
        <div class="flex flex-wrap gap-2">
          {entry.data.tags.map(tag => (
            <a
              href={`/tags/${tag}`}
              class="group inline-flex items-center gap-2 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300"
            >
              <span class="font-semibold">#{tag}</span>
              <svg class="w-4 h-4 opacity-0 -translate-x-1 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
              </svg>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- 相关文章推荐 -->
    {relatedPosts.length > 0 && (
      <div class="mt-16 pt-8 border-t border-slate-200">
        <h3 class="text-2xl font-black text-slate-900 mb-6">相关文章</h3>
        <div class="grid gap-6 md:grid-cols-3">
          {relatedPosts.map(post => (
            <a
              href={`/blog/${post.slug}`}
              class="group p-6 bg-white border border-slate-100 rounded-2xl hover:border-blue-500/20 hover:shadow-xl hover:shadow-blue-500/5 transition-all duration-500 hover:-translate-y-1"
            >
              <span class="text-[10px] font-black uppercase tracking-wider text-blue-600 mb-3 block">
                {post.data.category}
              </span>
              <h4 class="text-lg font-bold text-slate-900 mb-2 line-clamp-2 group-hover:text-blue-600 transition-colors">
                {post.data.title}
              </h4>
              <p class="text-sm text-slate-500 line-clamp-2">
                {post.data.description}
              </p>
              <div class="mt-4 flex items-center gap-2 text-xs text-slate-400">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <time>
                  {post.data.pubDate.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                  })}
                </time>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- 分享按钮（可选） -->
    <div class="mt-12 pt-8 border-t border-slate-200">
      <div class="flex items-center justify-between">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-slate-600 hover:text-blue-600 transition-colors"
        >
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
          </svg>
          <span class="font-semibold">返回首页</span>
        </a>

        <div class="flex items-center gap-3">
          <span class="text-sm text-slate-500">分享到：</span>
          <button class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 hover:bg-blue-500 hover:text-white transition-all duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/>
            </svg>
          </button>
          <button class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 hover:bg-green-500 hover:text-white transition-all duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </article>
</MainLayout>
