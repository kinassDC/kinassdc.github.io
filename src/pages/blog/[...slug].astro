---
import type { MarkdownHeading } from 'astro';
import MainLayout from '../../layouts/MainLayout.astro';
import '../../styles/global.css';
import { getCollection } from 'astro:content';

// 生成所有文章的路径
export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

// 获取当前文章数据
const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// 获取所有文章用于相关推荐（简单实现：同分类文章）
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(post => post.slug !== entry.slug && post.data.category === entry.data.category)
  .slice(0, 3);

// 获取文章的目录数据
type HeadingWithSubheadings = MarkdownHeading & {
  subheadings?: HeadingWithSubheadings[];
};

// 动态识别最高层级的标题
const minDepth = headings.length > 0 ? Math.min(...headings.map(h => h.depth)) : 2;

const grouppedHeadings = headings.reduce((array, heading) => {
  const relativeDepth = heading.depth - minDepth;

  if (relativeDepth === 0) {
    // 顶层标题
    array.push({ ...heading, subheadings: [] });
  } else if (relativeDepth === 1) {
    // 第二级标题
    array.at(-1)?.subheadings?.push({ ...heading, subheadings: [] });
  } else if (relativeDepth === 2) {
    // 第三级标题
    array.at(-1)?.subheadings?.at(-1)?.subheadings?.push({ ...heading, subheadings: [] })
  } else if (relativeDepth === 3) {
    // 第四级标题
    array.at(-1)?.subheadings?.at(-1)?.subheadings?.at(-1)?.subheadings?.push({ ...heading, subheadings: [] });
  }
  return array;
}, [] as HeadingWithSubheadings[]);
---

<MainLayout title={entry.data.title}>
  <!-- 文章头部信息 - sticky 容器 -->
  <div class="relative w-full bg-white border-b border-slate-100 overflow-hidden">
    <div class="absolute inset-0 bg-[radial-gradient(#f1f5f9_1.5px,transparent_1.5px)] [background-size:24px_24px] opacity-60"></div>
    <div class="absolute top-0 right-0 w-1/3 h-full bg-gradient-to-l from-slate-50/50 to-transparent"></div>

    <div class="relative max-w-5xl mx-auto px-8 py-14 lg:py-20">
      <div class="flex items-center gap-4 mb-8">
        <span class="px-3 py-1 bg-slate-900 text-white text-[10px] font-bold rounded-sm tracking-widest uppercase">
          {entry.data.category}
        </span>
        <time class="text-slate-400 text-xs font-medium tabular-nums">
          {entry.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.')}
        </time>
      </div>

      <div class="max-w-4xl">
        <h1 class="text-3xl lg:text-[2.75rem] font-extrabold text-slate-800 leading-[1.25] tracking-tight mb-8">
          {entry.data.title}
        </h1>
        
        {entry.data.description && (
          <p class="text-lg lg:text-xl text-slate-400 font-normal leading-relaxed max-w-3xl antialiased border-l-4 border-blue-500/10 pl-6 italic">
            {entry.data.description}
          </p>
        )}
      </div>

      <div class="mt-12 pt-8 border-t border-slate-50 flex items-center gap-8 text-[10px] font-bold text-slate-400 tracking-[0.2em] uppercase">
        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="flex gap-5">
            {entry.data.tags.slice(0, 3).map(tag => (
              <span class="hover:text-slate-900 transition-colors cursor-pointer transition-all duration-300">
                #{tag}
              </span>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- Flex 左右布局容器 -->
  <div class="flex gap-6 items-start justify-center py-4" id="content-wrapper">
    <!-- 左侧：目录（桌面端显示，移动端隐藏） -->
    <div class="hidden lg:block w-[280px] flex-shrink-0 sticky top-[5.5rem]" id="toc-sidebar">
      <div class="toc-header">
        <span class="toc-title">目录</span>
      </div>
      <ol class="toc-list" id="toc-list">
      {(()=>{

        const h = (heading:HeadingWithSubheadings) => {
          const hasChildren = heading.subheadings && heading.subheadings.length > 0;
          return (
          <li class:list={[`toc-item`, hasChildren && 'has-children']}>
            <div class="toc-item-row">
              <button class="toc-item-toggle" aria-label="折叠/展开" data-disabled={!hasChildren}>
                <svg class="toc-item-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <a href={`#${heading.slug}`} class="toc-link">{heading.text}</a>
            </div>
            { hasChildren && <ol class="toc-sublist"> { heading.subheadings.map((subheading) => h(subheading)) } </ol> }
          </li>
          )
        }
        return grouppedHeadings.map((heading) => h(heading))

      })()}
      </ol>
    </div>
    <!-- 右侧：文章容器 -->
    <article class="flex-1 max-w-4xl px-8 py-8 bg-white/70 backdrop-blur-xl rounded-[2.5rem] border border-white/50 shadow-xl shadow-blue-500/5">
      <!-- 文章正文 -->
      <div class="prose prose-base prose-slate prose-sm max-w-none">
        <Content />
      </div>

      <!-- 文章底部标签 -->
      {entry.data.tags && entry.data.tags.length > 0 && (
        <div class="mt-12 pt-8 border-t border-slate-200">
          <h3 class="text-sm font-black uppercase tracking-wider text-slate-700 mb-4">文章标签</h3>
          <div class="flex flex-wrap gap-2">
            {entry.data.tags.map(tag => (
              <a
                href={`/tags/${tag}`}
                class="group inline-flex items-center gap-2 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all duration-300"
              >
                <span class="font-semibold">#{tag}</span>
                <svg class="w-4 h-4 opacity-0 -translate-x-1 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                </svg>
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- 相关文章推荐 -->
      {relatedPosts.length > 0 && (
        <div class="mt-16 pt-8 border-t border-slate-200">
          <h3 class="text-2xl font-black text-slate-900 mb-6">相关文章</h3>
          <div class="grid gap-6 md:grid-cols-3">
            {relatedPosts.map(post => (
              <a
                href={`/blog/${post.slug}`}
                class="group p-6 bg-white border border-slate-100 rounded-2xl hover:border-blue-500/20 hover:shadow-xl hover:shadow-blue-500/5 transition-all duration-500 hover:-translate-y-1"
              >
                <span class="text-[10px] font-black uppercase tracking-wider text-blue-600 mb-3 block">
                  {post.data.category}
                </span>
                <h4 class="text-lg font-bold text-slate-900 mb-2 line-clamp-2 group-hover:text-blue-600 transition-colors">
                  {post.data.title}
                </h4>
                <p class="text-sm text-slate-500 line-clamp-2">
                  {post.data.description}
                </p>
                <div class="mt-4 flex items-center gap-2 text-xs text-slate-400">
                  <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <time>
                    {post.data.pubDate.toLocaleDateString('zh-CN', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </time>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- 分享按钮（可选） -->
      <div class="mt-12 pt-8 border-t border-slate-200">
        <div class="flex items-center justify-between">
          <a
            href="/"
            class="inline-flex items-center gap-2 text-slate-600 hover:text-blue-600 transition-colors"
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            <span class="font-semibold">返回首页</span>
          </a>

          <div class="flex items-center gap-3">
            <span class="text-sm text-slate-500">分享到：</span>
            <button class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 hover:bg-blue-500 hover:text-white transition-all duration-300">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/>
              </svg>
            </button>
            <button class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 hover:bg-green-500 hover:text-white transition-all duration-300">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </article>
  </div>
</MainLayout>

<style>
  /* 目录样式 */
  #toc-sidebar {
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(12px);
    border-radius: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  #toc-sidebar::-webkit-scrollbar {
    width: 4px;
  }

  #toc-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  #toc-sidebar::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.2);
    border-radius: 4px;
  }

  #toc-sidebar::-webkit-scrollbar-thumb:hover {
    background: rgba(148, 163, 184, 0.35);
  }

  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .toc-item {
    margin-bottom: 0.25rem;
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    color: #475569;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.15s ease;
  }

  .toc-link:hover {
    background: rgba(59, 130, 246, 0.08);
    color: #2563eb;
  }

  .toc-sublist {
    list-style: none;
    margin: 0;
    padding: 0;
    padding-left: 1.25rem;
  }

  .toc-sublist .toc-link {
    font-size: 0.8125rem;
    color: #64748b;
  }

  .toc-sublist .toc-sublist .toc-link {
    font-size: 0.75rem;
    color: #94a3b8;
  }

  /* 目录折叠功能 */
  .toc-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  }

  .toc-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #64748b;
  }

  .toc-item-row {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .toc-item-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    color: #64748b;
    padding: 0;
    flex-shrink: 0;
    transition: all 0.2s ease;
  }

  .toc-item-toggle[data-disabled="true"] {
    cursor: default;
    opacity: 0.3;
    pointer-events: none;
  }

  .toc-item-toggle:not([data-disabled="true"]):hover {
    color: #3b82f6;
  }

  .toc-item-chevron {
    width: 12px;
    height: 12px;
    transition: transform 0.3s ease;
  }

  .toc-item.has-children.collapsed .toc-item-chevron {
    transform: rotate(-90deg);
  }

  .toc-item.has-children.collapsed > .toc-item-row + .toc-sublist {
    display: none;
  }
</style>

<script>
  // 目录树状折叠功能
  (function() {
    const tocSidebar = document.getElementById('toc-sidebar');
    if (!tocSidebar) return;

    tocSidebar.addEventListener('click', (e) => {
      const toggleBtn = e.target.closest('.toc-item-toggle');
      if (!toggleBtn) return;

      const tocItem = toggleBtn.closest('.toc-item');
      if (!tocItem) return;

      tocItem.classList.toggle('collapsed');
    });
  })();
</script>
